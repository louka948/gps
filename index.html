<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GPS Surprise</title>

  <style>
    :root{
      --pink:#ff2f7b;
      --pink2:#ff78b3;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:#000;
      color:#fff;
      overflow-x:hidden;
      overflow-y:auto;
      -webkit-text-size-adjust:100%;
    }

    #gps{
      position:relative;
      width:100vw;
      height:100vh;
      min-height:100vh;
      overflow:hidden;
      background:#000;
    }

    /* ----- SC√àNE ROUTE ----- */
    #world{
      position:absolute;
      inset:0;
      transform-origin: 50% 65%;
      transition: transform 520ms cubic-bezier(.2,.9,.1,1);
      will-change: transform;
    }

    #scene{
      position:absolute; inset:0;
      background: radial-gradient(1100px 720px at 30% 12%, #2f4666 0%, #0c131f 55%, #06080d 100%);
    }
    #scene::before{
      content:"";
      position:absolute;
      inset:-35%;
      background:
        radial-gradient(900px 600px at 50% 12%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 70%),
        linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 60%, rgba(0,0,0,.78) 100%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.0) 0 24px, rgba(255,255,255,.22) 24px 38px);
      transform: perspective(800px) rotateX(62deg) translateY(18%);
      animation: road 1.15s linear infinite;
      opacity:.42;
      filter: blur(.2px);
    }
    #scene::after{
      content:"";
      position:absolute;
      left:50%;
      top:-10%;
      width:80%;
      height:140%;
      transform: translateX(-50%) perspective(800px) rotateX(62deg);
      background:
        linear-gradient(to right,
          transparent 0%,
          transparent 22%,
          rgba(255,255,255,.16) 22% 22.6%,
          transparent 22.6% 48.7%,
          rgba(255,255,255,.16) 48.7% 49.3%,
          transparent 49.3% 75.4%,
          rgba(255,255,255,.16) 75.4% 76.0%,
          transparent 76.0% 100%
        );
      opacity:.32;
      filter: blur(.2px);
    }
    @keyframes road{
      to{ transform: perspective(800px) rotateX(62deg) translateY(26%); }
    }

    /* flash visuel virage */
    #turnAnim{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:8;
      opacity:0;
    }
    #turnAnim.play{
      opacity:1;
      animation: turnFlash .55s ease both;
    }
    #turnAnim.right{ transform: scaleX(-1); }
    #turnAnim::before{
      content:"";
      position:absolute;
      left:50%;
      top:40%;
      width: 1400px;
      height: 900px;
      transform: translate(-50%,-50%);
      background:
        radial-gradient(closest-side at 45% 60%, rgba(255,120,179,.18), rgba(255,120,179,0) 65%),
        conic-gradient(from 250deg, rgba(255,255,255,.0) 0 25%, rgba(255,255,255,.20) 25% 35%, rgba(255,255,255,0) 35% 100%);
      filter: blur(1px);
    }
    @keyframes turnFlash{
      0%{ opacity:0; transform: translateY(0); }
      20%{ opacity:1; }
      100%{ opacity:0; transform: translateY(6px); }
    }

    /* ----- VOITURE ----- */
    #carWrap{
      position:absolute;
      left:50%;
      bottom: calc(110px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      z-index:9;
      pointer-events:none;
    }
    #car{
      width:160px;
      height:160px;
      display:grid;
      place-items:center;
      animation: carBob 1.1s ease-in-out infinite;
      filter: drop-shadow(0 26px 36px rgba(0,0,0,.65));
      transform-origin: 50% 70%;
      transition: transform 520ms cubic-bezier(.2,.9,.1,1);
      will-change: transform;
    }
    @keyframes carBob{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(3px); } }

    /* secousse courte */
    .carKick{ animation: carKick .36s ease both; }
    @keyframes carKick{
      0%{ filter: drop-shadow(0 26px 36px rgba(0,0,0,.65)); transform: translateY(0); }
      50%{ filter: drop-shadow(0 30px 40px rgba(0,0,0,.75)); transform: translateY(2px); }
      100%{ filter: drop-shadow(0 26px 36px rgba(0,0,0,.65)); transform: translateY(0); }
    }

    /* ----- OVERLAYS UI (pas dans #world) ----- */
    #topCard{
      position:absolute;
      top: calc(14px + env(safe-area-inset-top));
      left:50%;
      transform:translateX(-50%);
      display:flex;
      gap:14px;
      align-items:center;
      background:rgba(0,0,0,.86);
      color:#fff;
      padding:14px 16px;
      border-radius:18px;
      min-width:min(520px, 92vw);
      box-shadow: 0 14px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      z-index:20;
    }
    #topCard .arrow{
      width:46px; height:46px;
      display:grid; place-items:center;
      font-size:28px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
      user-select:none;
    }
    .tInfo .dist{ font-weight:950; font-size:22px; line-height:1.05; letter-spacing:.2px; }
    .tInfo .street{ margin-top:4px; font-weight:800; opacity:.92; letter-spacing:.2px; }

    #speedBubble{
      position:absolute;
      top: calc(14px + env(safe-area-inset-top));
      left: calc(50% - 210px);
      transform: translateX(-50%);
      background:rgba(0,0,0,.86);
      color:#fff;
      padding:10px 12px;
      border-radius:18px;
      text-align:center;
      width:92px;
      box-shadow: 0 14px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      z-index:20;
    }
    #speedBubble span{ font-weight:950; font-size:26px; display:block; line-height:1; }
    #speedBubble small{ display:block; opacity:.85; font-weight:800; margin-top:2px; }

    #leftGauge{
      position:absolute;
      top: calc(14px + env(safe-area-inset-top));
      left: 14px;
      width: 62px;
      height: 230px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      z-index:20;
    }
    .gTrack{
      width:18px; height:190px; border-radius:12px; overflow:hidden;
      background:rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .gFill{ width:100%; height:55%; background: linear-gradient(#2cff6a,#ffe45c,#ff4b4b); transition: height .25s ease; }
    .gKnob{ width:42px; height:42px; border-radius:50%; background: rgba(255,255,255,.92); box-shadow: 0 14px 30px rgba(0,0,0,.45); }

    #blueCards{
      position:absolute;
      top: 220px;
      right: 14px;
      display:flex;
      gap:12px;
      z-index:20;
    }
    .bCard{
      background: rgba(20,92,255,.82);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      min-width:160px;
      box-shadow: 0 14px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }
    .bCard.big{ min-width:190px; }
    .bTitle{ font-weight:950; opacity:.95; }
    .bSub{ margin-top:6px; font-weight:950; font-size:22px; }

    #bottomBar{
      position:absolute;
      bottom: calc(16px + env(safe-area-inset-bottom));
      left:50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.86);
      color:#fff;
      display:flex;
      gap:26px;
      padding:12px 18px;
      border-radius:18px;
      box-shadow: 0 14px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      z-index:20;
    }
    .bItem{ text-align:center; min-width:84px; }
    .bVal{ font-weight:950; font-size:24px; line-height:1.05; }
    .bLbl{ opacity:.8; font-weight:850; margin-top:2px; font-size:12px; letter-spacing:.2px; }

    #action{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(92px + env(safe-area-inset-bottom));
      border:none;
      border-radius:999px;
      padding:14px 26px;
      font-weight:950;
      font-size:16px;
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#fff;
      box-shadow: 0 14px 30px rgba(0,0,0,.45);
      cursor:pointer;
      z-index:20;
    }

    /* aide */
    #hintKeys{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(150px + env(safe-area-inset-bottom));
      padding:8px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      font-weight:800;
      font-size:12px;
      opacity:.85;
      z-index:20;
      user-select:none;
    }
    kbd{
      padding:2px 6px;
      border-radius:6px;
      background: rgba(255,255,255,.12);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px;
    }

    /* notif */
    #notification{
      position:absolute;
      left:50%;
      top: calc(98px + env(safe-area-inset-top));
      transform: translateX(-50%) translateY(-14px);
      width:min(520px, 92vw);
      background: rgba(0,0,0,.86);
      border-radius:18px;
      padding: 12px 14px;
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      z-index:22;
    }
    #notification.show{ opacity:1; transform: translateX(-50%) translateY(0); }
    .nRow{ display:flex; gap:10px; align-items:center; }
    .nAvatar{ width:44px; height:44px; border-radius:14px; background: rgba(255,255,255,.10); display:grid; place-items:center; font-size:22px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.10); }
    .nMeta{ flex:1; }
    .nTitle{ font-weight:950; letter-spacing:.2px; }
    .nText{ margin-top:2px; opacity:.92; font-weight:750; }

    /* final */
    #finalScreen{
      position:absolute;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.72);
      z-index:30;
    }
    #finalScreen.active{ display:grid; }
    .finalCard{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.95);
      border-radius:22px;
      padding:18px;
      text-align:center;
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
      color:#111;
    }
    .finalTitle{ font-weight:1000; font-size:22px; letter-spacing:.2px; }
    .finalSub{ font-weight:950; color: var(--pink); margin:8px 0 14px; }
    #finalImg{
      width:100%;
      max-height:60vh;
      object-fit:contain;
      border-radius:16px;
      display:block;
      margin:0 auto;
      box-shadow: 0 14px 30px rgba(0,0,0,.20);
      background:#000;
    }
    #finalErr{ display:none; margin-top:10px; font-weight:850; color:#c02020; }
    #finalErr.show{ display:block; }

    #spacer{ height: 56px; }
  </style>
</head>

<body>
  <div id="gps">
    <!-- monde qui tourne -->
    <div id="world">
      <div id="scene"></div>
      <div id="turnAnim"></div>
      <div id="carWrap">
        <div id="car" aria-hidden="true">
          <svg viewBox="0 0 64 64" width="150" height="150">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#f5f7fb"/>
                <stop offset="1" stop-color="#b9c1cc"/>
              </linearGradient>
              <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#0b1624" stop-opacity=".95"/>
                <stop offset="1" stop-color="#0b1624" stop-opacity=".55"/>
              </linearGradient>
            </defs>
            <ellipse cx="32" cy="54" rx="18" ry="6" fill="#000" opacity=".35"/>
            <path d="M18 48c-3 0-5-2-5-5V29c0-6 5-11 11-12l16-2c6-1 11 3 12 9l2 10c1 2 2 5 2 8 0 3-2 6-6 6H18z"
                  fill="url(#g1)" stroke="#ffffff" stroke-opacity=".25"/>
            <path d="M24 18l16-2c4-.5 7 2 8 6l1 6H15v-3c0-4 4-7 9-7z" fill="url(#g2)"/>
            <rect x="14" y="33" width="6" height="10" rx="2" fill="#ff2f7b" opacity=".9"/>
            <rect x="44" y="33" width="6" height="10" rx="2" fill="#ff2f7b" opacity=".9"/>
            <rect x="26" y="38" width="12" height="7" rx="2" fill="#1b1b1b" opacity=".6"/>
            <rect x="28" y="40" width="8" height="3" rx="1.5" fill="#dfe6ef" opacity=".85"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- overlay UI -->
    <div id="leftGauge">
      <div class="gTrack"><div class="gFill" id="gFill"></div></div>
      <div class="gKnob"></div>
    </div>

    <div id="speedBubble"><span id="speed">0</span><small>km/h</small></div>

    <div id="topCard">
      <div class="arrow" id="dirArrow">‚¨ÜÔ∏è</div>
      <div class="tInfo">
        <div class="dist" id="dirDist">24.7 km</div>
        <div class="street" id="dirStreet">Prendre la sortie 168</div>
      </div>
    </div>

    <div id="notification">
      <div class="nRow">
        <div class="nAvatar">üí¨</div>
        <div class="nMeta">
          <div class="nTitle">Copain</div>
          <div class="nText">Tu fais quoi ou es tu ma valentine ?</div>
        </div>
      </div>
    </div>

    <div id="blueCards">
      <div class="bCard">
        <div class="bTitle">P√©age</div>
        <div class="bSub" id="b1">26.1 km</div>
      </div>
      <div class="bCard big">
        <div class="bTitle">P√©age</div>
        <div class="bSub" id="b2">4 km</div>
      </div>
    </div>

    <div id="bottomBar">
      <div class="bItem"><div class="bVal" id="eta">7:45</div><div class="bLbl">arriv√©e</div></div>
      <div class="bItem"><div class="bVal" id="dur">49</div><div class="bLbl">min</div></div>
      <div class="bItem"><div class="bVal" id="km">37</div><div class="bLbl">km</div></div>
    </div>

    <button id="action">D√©marrer (ou fl√®ches)</button>
    <div id="hintKeys"><kbd>‚Üë</kbd> tout droit ¬∑ <kbd>‚Üê</kbd>/<kbd>‚Üí</kbd> tourner ¬∑ <kbd>‚Üì</kbd> continuer</div>

    <div id="finalScreen">
      <div class="finalCard">
        <div class="finalTitle">Vous √™tes arriv√© √† destination</div>
        <div class="finalSub">Voir la surprise üíù</div>
        <img id="finalImg" alt="Surprise" />
        <div id="finalErr">Image introuvable. Ajoute le fichier <b>surprise.jpg</b> √† la racine du repo.</div>
      </div>
    </div>
  </div>

  <div id="spacer"></div>

  <script>
    const $ = (id) => document.getElementById(id);

    const world     = $("world");
    const dirArrow  = $("dirArrow");
    const dirDist   = $("dirDist");
    const dirStreet = $("dirStreet");
    const speedEl   = $("speed");
    const etaEl     = $("eta");
    const durEl     = $("dur");
    const kmEl      = $("km");
    const gFill     = $("gFill");
    const b1        = $("b1");
    const b2        = $("b2");
    const action    = $("action");
    const notif     = $("notification");
    const turnAnim  = $("turnAnim");
    const car       = $("car");

    const finalScreen = $("finalScreen");
    const finalImg    = $("finalImg");
    const finalErr    = $("finalErr");

    const surprisePath = "surprise.jpg";

    // orientation du monde (en degr√©s)
    let heading = 0; // 0 = nord (tout droit)
    function normalizeDeg(d){
      d = d % 360;
      return d < 0 ? d + 360 : d;
    }
    function setHeading(newHeading){
      heading = normalizeDeg(newHeading);
      world.style.transform = `rotate(${heading}deg)`;
      car.style.transform = `rotate(${-heading}deg)`; // voiture reste ‚Äúdroite‚Äù
    }

    // √âtapes: on ne peut avancer qu'avec la bonne touche
    const steps = [
      { need:"UP",    label:"TOUT DROIT", arrow:"‚¨ÜÔ∏è", dist:"24.7 km", street:"Prendre la sortie 168", eta:"7:45", dur:"49", km:"37", speed:5,  turn:null,  b1:"26.1 km", b2:"4 km" },
      { need:"RIGHT", label:"DROITE",     arrow:"‚û°Ô∏è", dist:"18.5 km", street:"Tourner √† droite",      eta:"7:38", dur:"35", km:"28", speed:35, turn:"right", b1:"19.6 km", b2:"3 km" },
      { need:"UP",    label:"TOUT DROIT", arrow:"‚¨ÜÔ∏è", dist:"12.3 km", street:"Continuer tout droit",  eta:"7:30", dur:"25", km:"19", speed:45, turn:null,  b1:"13.0 km", b2:"2 km" },
      { need:"LEFT",  label:"GAUCHE",     arrow:"‚¨ÖÔ∏è", dist:"8.5 km",  street:"Tourner √† gauche",      eta:"7:25", dur:"18", km:"13", speed:40, turn:"left", b1:"8.9 km",  b2:"1 km" },
      { need:"RIGHT", label:"DROITE",     arrow:"‚ÜóÔ∏è", dist:"4.2 km",  street:"Bifurquer √† droite",    eta:"7:18", dur:"10", km:"6",  speed:50, turn:"right", b1:"4.5 km", b2:"700 m" },
      { need:"UP",    label:"TOUT DROIT", arrow:"‚¨ÜÔ∏è", dist:"1.5 km",  street:"Continuer tout droit",  eta:"7:12", dur:"4",  km:"2",  speed:30, turn:null,  b1:"1.6 km", b2:"300 m" },
      { need:"LEFT",  label:"GAUCHE",     arrow:"‚¨ÖÔ∏è", dist:"500 m",   street:"Derni√®re √† gauche",     eta:"7:10", dur:"2",  km:"0.5",speed:20, turn:"left", b1:"600 m",  b2:"150 m" },
      { need:"DOWN",  label:"ARRIV√âE",    arrow:"üéØ", dist:"0 m",     street:"Vous √™tes arriv√© √† destination ‚Äî Voir la surprise", eta:"7:08", dur:"0", km:"0", speed:0, turn:null, b1:"0 m", b2:"0 m" }
    ];

    let i = 0;             // step courant (0..)
    let started = false;
    let notifShown = false;

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function flashTurn(dir){
      turnAnim.classList.remove("play","right");
      if (dir === "right") turnAnim.classList.add("right");
      void turnAnim.offsetWidth;
      turnAnim.classList.add("play");
      setTimeout(() => turnAnim.classList.remove("play","right"), 650);

      car.classList.remove("carKick");
      void car.offsetWidth;
      car.classList.add("carKick");
      setTimeout(() => car.classList.remove("carKick"), 380);
    }

    function showMidNotification(){
      if (notifShown) return;
      const mid = Math.floor(steps.length / 2);
      if (i === mid){
        notifShown = true;
        notif.classList.add("show");
        setTimeout(() => notif.classList.remove("show"), 5200);
      }
    }

    function render(){
      const step = steps[i];

      dirArrow.textContent  = step.arrow;
      dirDist.textContent   = step.dist;
      dirStreet.textContent = step.street;

      speedEl.textContent = String(step.speed);
      etaEl.textContent   = step.eta;
      durEl.textContent   = step.dur;
      kmEl.textContent    = step.km;

      b1.textContent = step.b1;
      b2.textContent = step.b2;

      const progress = ((i + 1) / steps.length) * 100;
      const fill = 100 - progress;
      gFill.style.height = clamp(fill, 6, 94) + "%";

      action.textContent = i === steps.length - 1 ? "Voir la surprise üíù" : "D√©marrer (ou fl√®ches)";
      showMidNotification();
    }

    function openSurprise(){
      finalErr.classList.remove("show");
      finalImg.onerror = () => finalErr.classList.add("show");
      finalImg.src = surprisePath;
      finalScreen.classList.add("active");
      action.style.display = "none";
    }

    // mapping touches -> symbol
    function keyToMove(e){
      if (e.key === "ArrowUp") return "UP";
      if (e.key === "ArrowRight") return "RIGHT";
      if (e.key === "ArrowLeft") return "LEFT";
      if (e.key === "ArrowDown") return "DOWN";
      return null;
    }

    function applyMove(move){
      if (finalScreen.classList.contains("active")) return;

      // clic sur bouton = ‚Äúessayer la bonne touche‚Äù (si pas de clavier)
      if (move === "BTN") move = steps[i].need;

      // d√©j√† arriv√©e -> ouvrir
      if (i === steps.length - 1){
        openSurprise();
        return;
      }

      const need = steps[i].need;

      // si pas commenc√©, on autorise la premi√®re action quel que soit la touche
      if (!started){
        started = true;
        // si la premi√®re step attend UP mais l'utilisateur appuie autre chose, on l'ignore
        if (move !== need) return;
      } else {
        // en cours : il faut la bonne touche pour avancer
        if (move !== need) return;
      }

      // si l'√©tape est un virage, on fait tourner le monde + flash
      const turn = steps[i].turn;
      if (turn === "right"){
        setHeading(heading + 90);
        flashTurn("right");
      }
      if (turn === "left"){
        setHeading(heading - 90);
        flashTurn("left");
      }

      // avancer vers l'√©tape suivante
      i++;
      render();
    }

    // Bouton: simulate la bonne touche
    action.addEventListener("click", () => applyMove("BTN"));

    // Clavier
    window.addEventListener("keydown", (e) => {
      const m = keyToMove(e);
      if (!m) return;
      e.preventDefault();
      applyMove(m);
    });

    // init
    setHeading(0);
    render();
  </script>
</body>
</html>
